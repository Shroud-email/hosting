version: "3.9"
services:

  db:
    image: postgres:14.0-alpine3.14
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_DB=${DB_DATABASE}

  haraka:
    build: ./haraka
    restart: unless-stopped
    ports:
      - "25:25"
      - "465:465"
    environment:
      - EMAIL_DOMAIN=${EMAIL_DOMAIN}
    volumes:
      - ./haraka/haraka_config:/app/haraka_config
      - pem_certs:/app/haraka_config/config/certs

  web:
    image: ghcr.io/shroud-email/shroud.email:main
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "1587:1587"
    depends_on:
      - db
      - haraka
    environment:
      - APP_DOMAIN=${APP_DOMAIN}
      - EMAIL_DOMAIN=${EMAIL_DOMAIN}
      - DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_DATABASE}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - OH_MY_SMTP_API_KEY=${OH_MY_SMTP_API_KEY}
      - APPSIGNAL_PUSH_API_KEY=${APPSIGNAL_PUSH_API_KEY}
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY}
      - STRIPE_SECRET=${STRIPE_SECRET}
      - STRIPE_YEARLY_PRICE=${STRIPE_YEARLY_PRICE}
      - STRIPE_MONTHLY_PRICE=${STRIPE_MONTHLY_PRICE}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - NOTIFIER_WEBHOOK_URL=${NOTIFIER_WEBHOOK_URL}

  caddy:
    image: ghcr.io/shroud-email/caddy-permissive-file-storage:main
    restart: unless-stopped
    environment:
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - APP_DOMAIN=${APP_DOMAIN}
      - EMAIL_DOMAIN=${EMAIL_DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile

  cron:
    build: ./cron
    restart: unless-stopped
    environment:
      - EMAIL_DOMAIN=${EMAIL_DOMAIN}
    volumes:
      - caddy_data:/caddy
      - pem_certs:/pem

volumes:
  db_data:
  caddy_data:
  pem_certs: